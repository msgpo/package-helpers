#!/bin/sh
#
#    Copyright (C) 2008-2010  Rubén Rodríguez <ruben@trisquel.info>
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program; if not, write to the Free Software
#    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
#

VERSION=3

. ./config

#%FSDG: Remove functions to deal with proprietary drivers
rm ./DistUpgrade/xorg_fix_proprietary.py
rm ./DistUpgrade/NvidiaDetector
sed s/self.checkForNvidia/#self.checkForNvidia/ DistUpgrade/DistUpgradeCache.py -i
sed s/self._test_and_warn_on_old_nvidia/#self._test_and_warn_on_old_nvidia/  -i DistUpgrade/DistUpgradeQuirks.py
sed s/self._test_and_warn_on_nvidia_and_no_sse/#self._test_and_warn_on_nvidia_and_no_sse/  -i DistUpgrade/DistUpgradeQuirks.py
sed s/self._test_and_warn_on_dropped_fglrx_support/#self._test_and_warn_on_dropped_fglrx_support/  -i DistUpgrade/DistUpgradeQuirks.py
sed s/nvidia.*,// debian/control -i
sed s/fglrx.*// debian/control -i
sed /nvidia/d DistUpgrade/build-tarball.sh -i
sed /fglrx/d DistUpgrade/build-tarball.sh -i
rm tests/test-data/xorg.conf.fglrx
#% Make sure nvidia-common and fglrx-modaliases are not installed
apt-get remove --purge -y nvidia-common  || true
apt-get remove --purge -y fglrx-modaliases || true

cat > ./DistUpgrade/Trisquel.info << EOF
ChangelogURI: http://packages.trisquel.info/changelogs/pool/%s/%s/%s/%s_%s/%s

Suite: $CODENAME
RepositoryType: deb
BaseURI: http://archive.trisquel.info/trisquel/
Description: Trisquel $CODENAME
Component: main
Enabled: 1
CompDescription: Trisquel GNU/linux packages

Suite: $CODENAME-security
RepositoryType: deb
BaseURI: http://archive.trisquel.info/trisquel/
Description: Trisquel $CODENAME Security Updates
Component: main
Enabled: 1
CompDescription: Trisquel GNU/linux packages

Suite: $CODENAME-updates
RepositoryType: deb
BaseURI: http://archive.trisquel.info/trisquel/
Description: Trisquel $CODENAME Updates
Component: main
Enabled: 1
CompDescription: Trisquel GNU/linux packages

Suite: $CODENAME-backports
RepositoryType: deb
BaseURI: http://archive.trisquel.info/trisquel/
Description: Trisquel $CODENAME Backports
Component: main
Enabled: 1
CompDescription: Trisquel GNU/linux packages
EOF

cp ./DistUpgrade/Trisquel.info ./DistUpgrade/Ubuntu.info

cat << EOF >  DistUpgrade/ReleaseAnnouncement
= Welcome to Trisquel GNU/Linux $REVISION '$CODENAME' =

The Trisquel team is proud to announce Trisquel $REVISION '$CODENAME'.

Trisquel is a fully free operating system based in GNU/Linux, for domestic
users, small enterprises and educational centers.

We hope you enjoy Trisquel.

== Feedback and Helping ==

If you would like to help shape Trisquel, take a look at the list of 
ways you can participate at

  http://trisquel.info/en/wiki/how-help

Your comments, bug reports, patches and suggestions will help ensure
that our next release is the best release of Trisquel ever.  If you feel
that you have found a bug please send it to us via

  http://trisquel.info/project/issues

If you have a question, or if you think you may have found a bug but 
aren't sure, first try asking on the #trisquel IRC channel on Freenode,
on the Trisquel Users mailing list, or on the Trisquel forums:

 http://listas.trisquel.info/
 http://trisquel.info/forum

== More Information ==

You can find out more about Trisquel on our website, IRC channel and wiki.
If you're new to Trisquel, please visit:

  http://trisquel.info

To sign up for future Trisquel announcements, please subscribe to Trisquel's 
very low volume announcement list at:

  http://listas.trisquel.info/mailman/listinfo/trisquel-announce

EOF

cat << EOF >  DistUpgrade/DevelReleaseAnnouncement
This is a development release, do not install on production systems!

EOF

cat DistUpgrade/ReleaseAnnouncement >> DistUpgrade/DevelReleaseAnnouncement

cat <<EOF > DistUpgrade/removal_blacklist.cfg
# blacklist of packages that should never be removed
trisquel
trisquel-recommended
trisquel-base
trisquel-base-recommended
trisquel-desktop-common
trisquel-desktop-common-recommended
trisquel-gnome-base
trisquel-gnome-base-recommended
# update-manager itself should not remove itself
update-manager
update-manager-core
EOF

cat << EOF > DistUpgrade/mirrors.cfg
http://mirror.fsf.org/trisquel/
http://es.archive.trisquel.info/trisquel/
http://archive.trisquel.info/trisquel/
ftp://archive.trisquel.info/trisquel/
http://us.archive.trisquel.info/trisquel/
http://us2.archive.trisquel.info/trisquel/
EOF

cat << EOF > DistUpgrade/DistUpgrade.cfg
[View]
# the views will be tried in this order, if one fails to import, the next
# is tried
View=DistUpgradeViewGtk,DistUpgradeViewKDE,DistUpgradeViewText
#View=DistUpgradeViewNonInteractive
#Depends= python-apt (>= 0.6.0), apt (>= 0.6)
# the views below support upgrades over ssh connection
SupportSSH=DistUpgradeViewText,DistUpgradeViewNonInteractive

# Distro contains global information about the upgrade
[Distro]
# the meta-pkgs we support
MetaPkgs=trisquel
BaseMetaPkgs=trisquel-base, trisquel-desktop-common, trisquel-gnome-base
Demotions=demoted.cfg
RemoveEssentialOk=sysvinit, sysvutils, belocs-locales-bin
RemovalBlacklistFile=removal_blacklist.cfg
# if those packages were installed, make sure to keep them installed
KeepInstalledPkgs=gnumeric, hpijs, xserver-xorg-video-all, mysql-server, mysql-client
KeepInstalledSection=translations
RemoveObsoletes=yes
ForcedObsoletes=ksplash-engine-moodin, powernowd, laptop-mode-tools
# hints for for stuff that should be done early
PostUpgradePurge=ltsp-client, ltspfsd
PostUpgradeRemove=libflashsupport, kvm-source, gtk-qt-engine, libparted1.8-12, usplash
PostUpgradeUpgrade=brasero
#PostUpgradeInstall=apt
PostInstallScripts=./trisquel-postinstall.sh
EnableApport=no
# this supported blacklisting certain versions to ensure we do not upgrade
#  - the openoffice.org-filter-binfilter causes a pre-depends cycle error
#    (#516727)
BadVersions=openoffice.org-filter-binfilter_1:3.2.0~rc4-1ubuntu1
# ubiquity slideshow
#SlideshowUrl=http://people.canonical.com/~mvo/ubiquity-slideshow-upgrade/slides/

[KernelRemoval]
Version=2.6.31
BaseNames=linux-image,linux-headers,linux-image-debug,linux-backport-modules,linux-header-lbm
Types=386,ec2,generic,rt,server,virtual

# information about the individual meta-pkgs
[trisquel-gnome-base]
KeyDependencies=gdm, trisquel-sounds
# those pkgs will be marked remove right after the distUpgrade in the cache
PostUpgradeRemove=xscreensaver, gnome-cups-manager, powermanagement-interface, deskbar-applet, nautilus-cd-burner
ForcedObsoletes=desktop-effects, cups-pdf, policykit-gnome, gnome-mount

[Files]
BackupExt=distUpgrade
LogDir=/var/log/dist-upgrade/

[Sources]
From=awen
To=taranis
ValidOrigin=Trisquel
ValidMirrors = mirrors.cfg
Components=main

;[PreRequists]
;Packages=release-upgrader-apt,release-upgrader-dpkg
;SourcesList=prerequists-sources.list
;SourcesList-ia64=prerequists-sources.ports.list
;SourcesList-hppa=prerequists-sources.ports.list

[Aufs]
; this is a xor option, either full or chroot overlay
;EnableFullOverlay=yes
;EnableChrootOverlay=yes
; sync changes from the chroot back to the real system
;EnableChrootRsync=yes
; what chroot dir to use
;ChrootDir=/tmp/upgrade-chroot
; the RW dir to use (either for full overlay or chroot overlay)
;RWDir=/tmp/upgrade-rw

[Network]
MaxRetries=3

[NonInteractive]
ForceOverwrite=yes
RealReboot=no
DebugBrokenScripts=no
DpkgProgressLog=no
;TerminalTimeout=2400
EOF

cat << EOF1 > DistUpgrade/trisquel-postinstall.sh
#!/bin/sh

#This loop takes back the panel configuration to the default settings
export LANG=C
for user in root \$(grep /home /etc/passwd |egrep -v '(false|nologin)\$'| cut -d: -f1)
do
    if [ -f /home/\$user/.dbus/session-bus/\$(cat /var/lib/dbus/machine-id)-0 ]
    then
        DBUS_SESSION=\$(grep -v "^#" /home/\$user/.dbus/session-bus/\$(cat /var/lib/dbus/machine-id)-0)
        sudo -u \$user \$DBUS_SESSION gconftool --recursive-unset /apps/panel 2>&1 | grep -q "Connection refused"
        if [ \$? = 0 ]
        then
            sudo -u \$user gconftool --recursive-unset /apps/panel
            sudo -u \$user gconftool --shutdown
        fi
    else
        sudo -u \$user gconftool --recursive-unset /apps/panel
        sudo -u \$user gconftool --shutdown
    fi
done

sed -i 's:/archive.trisquel.info/:/es.archive.trisquel.info/:g; s/extras//g;' /etc/apt/sources.list
apt-get update
for i in trisquel-usplash-theme lubuntu-plymouth-theme usb-creator usb-creator-common usb-creator-gtk
do
apt-get remove --purge --force-yes -y \$i
done

apt-get install --force-yes -y trisquel-recommended

sudo -u gdm gconftool-2 --set --type string --set /apps/gdm/simple-greeter/logo_icon_name trisquel
sudo -u gdm gconftool-2 --set --type string --set /desktop/gnome/interface/gtk_theme Trisquel
sudo -u gdm gconftool-2 --set --type string --set /desktop/gnome/interface/icon_theme Trisquel
sudo -u gdm gconftool-2 --set --type string --set /desktop/gnome/background/picture_filename /usr/share/backgrounds/taranis.jpg
sudo -u gdm gconftool-2 --set --type string --set /desktop/gnome/background/picture_options stretched

[ -f /boot/grub/menu.lst ] && sed 's/Trisquel 3.5,/Trisquel 4.0,/g' /boot/grub/menu.lst -i

cat << EOF > /etc/grub.d/01_PASSWORD
#! /bin/sh -e
# Trisquel enables a random password to grub during install
# Comment this file to remove the password.
# This file should only be readable by root.

echo set superusers=grub
echo password grub \$(bash -c 'echo \$RANDOM')
EOF

update-initramfs -u
update-grub
EOF1
chmod 755 DistUpgrade/trisquel-postinstall.sh

echo > DistUpgrade/demoted.cfg

sed -i 's:changelogs\.ubuntu\.com:packages\.trisquel\.info:g' UpdateManager/*.py DistUpgrade/*.py ./po/*.po UpdateManager/Core/*.py data/meta-release

sed -i 's/�~Lubuntu/�~Ltrisquel/g; s/被ubuntu/被trisquel/g; s#http://launchpad.net/ubuntu/+source/%s/%s/+changelog#http://trisquel.info/project/issues#g; s/<.*@ubuntu.com/<info@trisquel.info/g; s/ ubuntu\n/ trisquel\n/g; s/ubuntu\ /trisquel\ /g; s/\ ubuntu/\ trisquel/g; s/Ubuntu/Trisquel/g; s/ubuntu-desktop/trisquel-/g; s/www.ubuntu.com/trisquel.info/g; s/www.ubuntulinux.org/trisquel.info/g ' po/*.po $(find | grep py$) $(find | grep '\.glade$')
#sed -i 's/�~Lubuntu/�~Ltrisquel/g; s/被ubuntu/被trisquel/g; s#http://launchpad.net/ubuntu/+source/%s/%s/+changelog#http://trisquel.info/project/issues#g; s/<.*@ubuntu.com/<info@trisquel.info/g; s/ ubuntu\n/ trisquel\n/g; s/ubuntu\ /trisquel\ /g; s/\ ubuntu/\ trisquel/g; s/Ubuntu/Trisquel/g; s/xubuntu/trisquel-mini/g; s/kubuntu/trisquel-pro/g; s/edubuntu/trisquel-edu/g; s/ubuntu-desktop/trisquel-/g; s/www.ubuntu.com/trisquel.info/g; s/www.ubuntulinux.org/trisquel.info/g ' po/*.po $(find | grep py$) $(find | grep '\.glade$')

apt-get install --force-yes -y rpl
rpl lucid $CODENAME . -R
rpl karmic awen . -R
rpl jaunty dwyn . -R
rpl hardy robur . -R
rpl " Ubuntu " " Trisquel " . -R
rpl " ubuntu " " trisquel " . -R
rpl archive.ubuntu.com/ubuntu es.archive.trisquel.info/trisquel . -R
rpl security.ubuntu.com/ubuntu archive.trisquel.info/trisquel . -R
rpl archive.ubuntu.com es.archive.trisquel.info . -R
rpl security.ubuntu.com es.archive.trisquel.info . -R
sed 's/auto generated by update-manager/auto generated by update-manager\\n/g' DistUpgrade/DistUpgradeController.py -i
sed 's/main restricted" %/main\\n" %/g' DistUpgrade/DistUpgradeController.py -i
rpl "main restricted" "main" DistUpgrade -R
sed 's/,"restricted"//g' DistUpgrade/DistUpgradeController.py -i
#sed 's/","restricted"/\\n"/g' DistUpgrade/DistUpgradeController.py -i
rpl '10.04' $REVISION DistUpgrade po -R

changelog "Compiled for Trisquel"

compile

